version: '3.8'

services:
  # 1. The Message Broker (Redpanda)
  # Acts as the central nervous system. Scrapers write here; processors read from here.
  redpanda:
    image: docker.redpanda.com/redpandadata/redpanda:v23.2.14
    container_name: redpanda
    command:
      - redpanda start
      - --smp 1 # Limit to 1 CPU core (good for dev)
      - --memory 1G
      - --reserve-memory 0M
      - --overprovisioned
      - --kafka-addr internal://0.0.0.0:9092,external://0.0.0.0:19092
      - --advertise-kafka-addr internal://redpanda:9092,external://localhost:19092
      - --pandaproxy-addr internal://0.0.0.0:8082,external://0.0.0.0:18082
      - --advertise-pandaproxy-addr internal://redpanda:8082,external://localhost:18082
    ports:
      - '19092:19092' # Kafka API accessible from host
      - '18082:18082' # HTTP Proxy
      - '9644:9644' # Admin API
    volumes:
      - redpanda-data:/var/lib/redpanda/data
    healthcheck:
      test: ['CMD-SHELL', 'rpk cluster health']
      interval: 10s
      timeout: 5s
      retries: 5

  # 2. The UI for Redpanda (Redpanda Console)
  # Visualizes topics and messages. Crucial for debugging.
  redpanda-console:
    image: docker.redpanda.com/redpandadata/console:v2.3.1
    container_name: redpanda-console
    environment:
      KAFKA_BROKERS: redpanda:9092
    ports:
      - '8080:8080'
    depends_on:
      - redpanda
    # Restart console even if it crashes
    restart: unless-stopped

  # 3. The Database (PostgreSQL)
  # Persistent storage for parsed data and model predictions.
  postgres:
    image: postgres:15-alpine
    container_name: retail-postgres
    environment:
      POSTGRES_USER: retail_user
      POSTGRES_PASSWORD: retail_password
      POSTGRES_DB: retail_db
    ports:
      - '5432:5432'
    volumes:
      - postgres-data:/var/lib/postgresql/data

  # 3. The Object Storage Server
  minio:
    image: minio/minio:latest
    container_name: minio
    ports:
      - '9000:9000' # API Port
      - '9001:9001' # Console UI Port
    environment:
      MINIO_ROOT_USER: minio_user
      MINIO_ROOT_PASSWORD: minio_password
    command: server /data --console-address ":9001"
    volumes:
      - minio_data:/data
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:9000/minio/health/live']
      interval: 30s
      timeout: 20s
      retries: 3

  # 4. The Setup Job (Creates the bucket automatically)
  minio-setup:
    image: minio/mc:latest
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      /usr/bin/mc alias set myminio http://minio:9000 minio_user minio_password;
      /usr/bin/mc mb myminio/dvc-storage;
      /usr/bin/mc anonymous set public myminio/dvc-storage;
      exit 0;
      "

  # 5. The Metrics Server (Prometheus)
  # Collects and stores metrics for analysis
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    ports:
      - '9090:9090'
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
    extra_hosts:
      - 'host.docker.internal:host-gateway' # Crucial for Linux support

  # 6. The Data Visualization Tool (Grafana)
  # Visualizes metrics in real-time
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports:
      - '3000:3000'
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    depends_on:
      - prometheus

volumes:
  redpanda-data:
  postgres-data:
  minio_data:
